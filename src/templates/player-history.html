{% extends 'base.html' %}
{% block title %}{{ chart_info['title'] }}{% endblock %}
{% block content %}
    <div class="container-lg text-white">
    <h1>{{ chart_info['title'] }}</h1>
    <h4>{{ chart_info['artist'] }}</h4>
    <h4>{{ chart_info['note_charter'] }}</h4>
    <div class="d-flex flex-row-reverse">
        <div class="btn-group mx-1" role="group" aria-label="Guage options">
            <a href="history?player_id={{ player_id }}&chart_id={{ chart_info['music_code'] }}&gauge_difficulty=0"
               class="btn {% if gauge_difficulty == 0 %}btn-success{% else %}btn-secondary{% endif %}">Easy</a>
            <a href="history?player_id={{ player_id }}&chart_id={{ chart_info['music_code'] }}&gauge_difficulty=1"
               class="btn {% if gauge_difficulty == 1 %}btn-warning{% else %}btn-secondary{% endif %}">Normal</a>
            <a href="history?player_id={{ player_id }}&chart_id={{ chart_info['music_code'] }}&gauge_difficulty=2"
               class="btn {% if gauge_difficulty == 2 %}btn-danger{% else %}btn-secondary{% endif %}">Hard</a>
        </div>
        <a href="/music-scoreboard/{{ chart_info['music_code'] }}/{{ gauge_difficulty }}"
           class="btn btn-outline-secondary mx-1">
            Go Ranking
        </a>
    </div>
    <hr style="border: 1px solid darkgrey" class="mb-3 mt-3">
    2023년 12월 20일 이전 기록은 조회되지 않습니다.
    <br>
    Records before December 20th, 2023, are not available for viewing.
    <div class="row mb-3 mt-3">
        <div class="col-auto me-auto">
            <span class="badge bg-info bg-opacity-75">PLAYER : {{ player_info['nickname'] }}</span>
            {% if chart_info['difficulty'] == 0 %}
                <span class="badge bg-success">LEVEL {{ chart_info['level'] }}</span>
            {% elif chart_info['difficulty'] == 1 %}
                <span class="badge bg-warning">LEVEL {{ chart_info['level'] }}</span>
            {% else %}
                <span class="badge bg-danger">LEVEL {{ chart_info['level'] }}</span>
            {% endif %}
            <span class="badge bg-secondary">BPM : {{ chart_info['bpm'] }}</span>
        </div>
        <div class="col-auto">
            <a id="order-by-date" class="btn btn-outline-light btn-sm {% if order_by_date == 1 %}active{% endif %}"
               {% if order_by_date == 1 %}aria-pressed="true"{% endif %} data-bs-toggle="button">Order by Date</a>
        </div>
    </div>
    {% if histories != [] %}
        <div class="container-fluid">
        {% for score in histories %}
            <div class="track-item {% if score['is_cleared_record'] != 1 %}failed{% endif %} track-item-inline mx-auto">
                <!-- Level Badge -->
                {% if score['row_number'] == 1 %}
                    <span class="badge rank first_tag">
                        #{{ score['row_number'] }}
                    </span>
                {% elif score['row_number'] == 2 %}
                    <span class="badge rank second_tag">
                        #{{ score['row_number'] }}
                    </span>
                {% elif score['row_number'] == 3 %}
                    <span class="badge rank third_tag">
                        #{{ score['row_number'] }}
                    </span>
                {% else %}
                    <span class="badge rank">
                        #{{ score['row_number'] }}
                    </span>
                {% endif %}

                <!-- Stats Section -->
                <div class="track-info-inline">
                    <div class="stats-container">
                        <span class="stat">
                            <span class="stat-label">COOL</span>
                            <span class="stat-value">{{ score['score_cool'] }}</span>
                        </span>
                        <span class="stat">
                            <span class="stat-label">GOOD</span>
                            <span class="stat-value">{{ score['score_good'] }}</span>
                        </span>
                        <span class="stat">
                            <span class="stat-label">BAD</span>
                            <span class="stat-value">{{ score['score_bad'] }}</span>
                        </span>
                        <span class="stat">
                            <span class="stat-label">MISS</span>
                            <span class="stat-value">{{ score['score_miss'] }}</span>
                        </span>
                        <span class="stat">
                            <span class="stat-label">COMBO</span>
                            <span class="stat-value">{{ score['score_max_combo'] }}</span>
                        </span>
                    </div>
                </div>

                <!-- Status Badges -->
                <div class="stats-inline">
                    {% if score['play_speed_rate'] is not none and score['play_speed_rate'] != 1.0 %}
                        <span class="badge {% if score['play_speed_rate'] is not none and score['play_speed_rate'] > 1.0 %}rate_tag_upper{% else %}rate_tag_lower{% endif %}">x{{ score['play_speed_rate'] }}</span>
                    {% endif %}
                    {% if score['play_timing_rate'] is not none and score['play_timing_rate'] != 0 %}
                        <span class="badge mod_tag">T{{ score['play_timing_rate'] }}</span>
                    {% endif %}
                    {% if score['fln_option'] is not none and score['fln_option'] == 1 %}
                        <span class="badge mod_tag">FLN {{ score['fln_option'] }}</span>
                    {% endif %}
                    {% if score['sln_option'] is not none and score['sln_option'] == 1 %}
                        <span class="badge mod_tag">SLN {{ score['sln_option'] }}</span>
                    {% endif %}
                    {% if score['is_nln'] is not none and score['is_nln'] == 1 %}
                        <span class="badge mod_tag">NLN</span>
                    {% endif %}
                    {% if score['pattern_order'] is not none and score['pattern_order'] != "1234567" %}
                        <span class="badge pattern_order_tag">{{ score['pattern_order'] }}</span>
                    {% endif %}
                </div>

                <!-- Score Section -->
                <div class="score-section">
                    <div class="score">{{ score['score'] }}</div>
                    {% if score['progress'] == 'P' or score['progress'] == 1 %}
                        <span class="badge p_grade_tag">P</span>
                    {% elif score['progress'] == 'SS' or score['progress'] == 2 %}
                        <span class="badge ss_grade_tag">SS</span>
                    {% elif score['progress'] == 'S' or score['progress'] == 3 %}
                        <span class="badge s_grade_tag">S</span>
                    {% elif score['progress'] == 'A' or score['progress'] == 4 %}
                        <span class="badge a_grade_tag">A</span>
                    {% elif score['progress'] == 'B' or score['progress'] == 5 %}
                        <span class="badge b_grade_tag">B</span>
                    {% elif score['progress'] == 'C' or score['progress'] == 6 %}
                        <span class="badge c_grade_tag">C</span>
                    {% elif score['progress'] == 'D' or score['progress'] == 7 %}
                        <span class="badge d_grade_tag">D</span>
                    {% elif score['progress'] == 'F' or score['progress'] == 8 %}
                        <span class="badge f_grade_tag">F</span>
                    {% endif %}
                </div>
                <!-- Right Section -->
                <div class="right-section">
                    <span class="timestamp">{{ score['cleared_time'] }}</span>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="text-white info-header">
            <div class="d-flex justify-content-center">
                <h3>YOU HAVEN'T PLAYED THIS CHART!</h3>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
{% block scripts %}
    <script>
        const levelChart = document.getElementById('level-chart');
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
        const popoverList = [...popoverTriggerList].map(popoverTriggerEl =>
            new bootstrap.Popover(popoverTriggerEl, {
                trigger: 'focus'
            })
        );

        const url = new URL(window.location.href);
        const parameters = url.searchParams;

        let orderByDateButton = document.getElementById("order-by-date");
        let orderByDate = parameters.get("order_by_date") == "true";
        let playerId = parameters.get("player_id");
        let chartId = parameters.get("chart_id");
        let gaugeDifficulty = parameters.get("gauge_difficulty");

        function setOption() {
            let newUrl = new URL("/history", url);

            if (orderByDate) {
                newUrl.searchParams.set("order_by_date", true);
            } else {
                newUrl.searchParams.set("order_by_date", false);
            }

            newUrl.searchParams.set("player_id", playerId);
            newUrl.searchParams.set("chart_id", chartId);
            newUrl.searchParams.set("gauge_difficulty", gaugeDifficulty);

            window.location.replace(newUrl);
        }

        orderByDateButton.addEventListener("click", () => {
            orderByDate = !orderByDate;
            setOption();
        });
    </script>
{% endblock %}